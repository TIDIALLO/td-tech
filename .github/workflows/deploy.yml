name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permet de d√©clencher manuellement

env:
  NODE_ENV: production

jobs:
  test:
    name: Test & Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Generate Prisma Client
        run: npx prisma generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://user:pass@localhost:5432/test' }}
        continue-on-error: true

      - name: Run Lint
        run: npm run lint
        continue-on-error: true

      - name: Build Next.js
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://user:pass@localhost:5432/test' }}
          AUTH_SECRET: ${{ secrets.AUTH_SECRET || 'test-secret-for-build' }}
          AUTH_URL: ${{ secrets.AUTH_URL || 'http://localhost:3000' }}
          NODE_ENV: production
        continue-on-error: true

  deploy-vps:
    name: Deploy to VPS
    needs: test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS via SSH
        if: ${{ secrets.VPS_HOST != '' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e
            echo "üöÄ Starting deployment to VPS..."
            
            # Variables
            DEPLOY_PATH="${{ secrets.VPS_DEPLOY_PATH || '/var/www/synap6ia' }}"
            BRANCH="${{ github.ref_name }}"
            APP_NAME="synap6ia"
            PORT="${{ secrets.PORT || '3002' }}"

            echo "üöÄ Deploying to: $DEPLOY_PATH"
            echo "üìç Branch: $BRANCH"
            echo "üî¢ Port: $PORT"

            # Naviguer vers le r√©pertoire du projet
            cd $DEPLOY_PATH || { echo "‚ùå Directory $DEPLOY_PATH not found!"; exit 1; }

            # Sauvegarder les variables d'environnement
            if [ -f .env ]; then
              cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
              echo "‚úÖ .env file backed up"
            fi

            # Pull les derni√®res modifications
            echo "üì• Pulling latest changes from $BRANCH..."
            git fetch origin
            git reset --hard origin/$BRANCH || git reset --hard origin/main

            # Installer les d√©pendances
            echo "üì¶ Installing dependencies..."
            npm ci --legacy-peer-deps || npm install --legacy-peer-deps

            # G√©n√©rer Prisma Client
            echo "üîß Generating Prisma Client..."
            npx prisma generate || echo "‚ö†Ô∏è Prisma generate failed, continuing..."

            # Build
            echo "üèóÔ∏è Building Next.js application..."
            npm run build || { echo "‚ùå Build failed!"; exit 1; }

            # Appliquer les migrations ou push le sch√©ma
            echo "üóÑÔ∏è Setting up database..."
            if [ -d "prisma/migrations" ] && [ "$(ls -A prisma/migrations)" ]; then
              echo "üì¶ Migrations found, applying..."
              npx prisma migrate deploy || {
                echo "‚ö†Ô∏è Migration failed, trying db push..."
                npx prisma db push --accept-data-loss || echo "‚ö†Ô∏è DB push also failed, continuing..."
              }
            else
              echo "‚ö†Ô∏è No migrations found, using db push..."
              npx prisma db push --accept-data-loss || echo "‚ö†Ô∏è DB push failed, continuing..."
            fi

            # Red√©marrer avec PM2
            if command -v pm2 &> /dev/null; then
              echo "üîÑ Managing PM2 process..."

              # V√©rifier si l'app existe d√©j√†
              if pm2 list | grep -q "$APP_NAME"; then
                echo "‚ôªÔ∏è  Restarting existing PM2 app: $APP_NAME"
                pm2 restart $APP_NAME
              else
                echo "üÜï Starting new PM2 app: $APP_NAME"
                PORT=$PORT pm2 start npm --name $APP_NAME -- start
              fi

              # Sauvegarder la configuration PM2
              pm2 save

              # Afficher le statut
              pm2 list
              echo "‚úÖ PM2 process restarted successfully"
            else
              echo "‚ùå PM2 not found! Please install PM2: npm install -g pm2"
              exit 1
            fi

            echo ""
            echo "‚úÖ Deployment completed successfully!"
            echo "üåê Application available at: https://synap6ia.com"
            echo "üìä Check logs with: pm2 logs $APP_NAME"

  deploy-vercel:
    name: Deploy to Vercel
    needs: test
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        id: vercel-env
        if: ${{ secrets.VERCEL_TOKEN != '' && secrets.VERCEL_ORG_ID != '' && secrets.VERCEL_PROJECT_ID != '' && secrets.VPS_HOST == '' }}
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--yes'
          scope: ${{ secrets.VERCEL_ORG_ID }}

      - name: Deploy to Vercel Production
        if: ${{ secrets.VERCEL_TOKEN != '' && secrets.VERCEL_ORG_ID != '' && secrets.VERCEL_PROJECT_ID != '' && secrets.VPS_HOST == '' }}
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod --yes'
          scope: ${{ secrets.VERCEL_ORG_ID }}

  notify:
    name: Notify Deployment Status
    needs: [test]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Check Deployment Status
        run: |
          echo "üìä Deployment Status Check"
          echo "Test job status: ${{ needs.test.result }}"
          
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "‚úÖ Build and tests passed successfully!"
            echo "üöÄ Your application is ready for deployment"
            echo ""
            echo "‚ÑπÔ∏è  Note: Vercel deployment happens automatically via Git integration"
            echo "‚ÑπÔ∏è  If you use VPS, configure VPS secrets to enable VPS deployment"
          else
            echo "‚ùå Build or tests failed!"
            echo "Please check the logs for more details"
            exit 1
          fi
